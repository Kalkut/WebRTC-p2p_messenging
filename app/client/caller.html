<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Caller page</title>
    <script src="signalingChannelFactory.js"></script>
    <script src="caller.js"></script>
    <script language="javascript" type="text/javascript">
        var eventEmitter = document.createElement('event-emitter');


        window.addEventListener("load", function(){
            var received = document.getElementById('received')
            var peers = document.getElementById('peers')

            function addPeer (id) {
                var newPeer = document.createElement('li');
                newPeer.id = id;
                newPeer.innerText = 'Peer nÂ°' + id;
                peers.appendChild(newPeer);
            }

            eventEmitter.addEventListener('id', function (e) {
                console.log(e.detail, 'id fetched')
                window.id = e.detail;
            })

            eventEmitter.addEventListener('connection', function (e) {
                console.log('connection', e.detail);
                addPeer(e.detail);
            })

            eventEmitter.addEventListener('peers', function (e) {
                
                e.detail
                .filter(function (peer) {return +peer !== window.id })
                
                //.forEach(addPeer)
            })

            eventEmitter.addEventListener('disconnection', function (e) {
                var lostPeer = document.getElementById(e.detail);
                lostPeer.parentNode.removeChild(lostPeer);
            })

            initCaller(function(message){
                var newText = document.createTextNode(message);
                received.appendChild(newText);
            }, eventEmitter);
            
            document.getElementById("send").onclick= function(){
                var message = document.getElementById('message').value;
                channel.send(message);
            };
            
            document.getElementById("start").onclick= function(){
                startCommunication(2);
            };
        }, false);
    </script>
</head>
<body>
    <h2>Caller page</h2>
    <button id="start">Start</button>
    <textarea id="message"></textarea>
    <p id="received"></p>
    <button id="send">Send message</button>
    <ul id="peers"></ul>
</body>
</html>